<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RIUM SCM - 상품 관리</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
    <style>
        /* SCM Specific Styles */
        body.scm-body {
            background-color: #f5f7fa;
            display: flex;
            min-height: 100vh;
            overflow-x: hidden;
            margin: 0;
            padding: 0;
            font-family: 'Open Sans', 'Noto Sans KR', sans-serif;
        }

        /* Sidebar - Aligned with User Mode */
        .scm-sidebar {
            width: 100px;
            min-width: 100px !important;
            max-width: 100px !important;
            background-color: #1a1a1a;
            color: white;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            transition: width 0.3s;
            height: 100vh;
            position: sticky;
            top: 0;
            overflow-y: auto;
            z-index: 100;
        }

        .scm-logo-area {
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .scm-logo-area a {
            font-family: 'Montserrat', sans-serif;
            font-size: 1rem;
            font-weight: 800;
            color: white;
            text-decoration: none;
            letter-spacing: 1px;
            text-align: center;
            line-height: 1.2;
        }

        .scm-menu {
            padding: 1rem 0;
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .scm-nav-item,
        .scm-menu-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1rem 0.5rem;
            color: #aaa;
            text-decoration: none;
            transition: all 0.3s;
            border-left: 3px solid transparent;
            text-align: center;
            width: 100%;
            height: auto;
            box-sizing: border-box;
        }

        .scm-nav-item:hover,
        .scm-menu-item:hover,
        .scm-nav-item.active,
        .scm-menu-item.active {
            background-color: rgba(255, 255, 255, 0.05);
            color: white;
            border-left-color: #00897B;
            /* Primary Color */
            padding-left: 0.5rem;
            /* Reset padding shift from previous style */
        }

        .scm-nav-item i,
        .scm-menu-item i {
            width: auto;
            font-size: 1.5rem;
            margin-right: 0;
            margin-bottom: 0.5rem;
        }

        .scm-nav-item span,
        .scm-menu-item span {
            font-size: 0.8rem;
            word-break: keep-all;
            line-height: 1.2;
        }

        .scm-main {
            flex: 1;
            padding: 2rem;
            height: 100vh;
            overflow-y: auto;
        }

        .scm-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e2e8f0;
        }

        /* Filter Bar & Action Bar */
        .scm-action-bar,
        .scm-filter-bar {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.02);
        }

        .scm-action-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .scm-input-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .scm-input {
            padding: 0.5rem;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .scm-select {
            padding: 0.5rem;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            font-size: 0.9rem;
            background-color: white;
        }

        .scm-btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
        }

        .scm-btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
        }

        .btn-blue {
            background-color: #3182ce;
            color: white;
        }

        .btn-blue:hover {
            background-color: #2c5282;
        }

        .btn-green {
            background-color: #38a169;
            color: white;
        }

        .btn-green:hover {
            background-color: #276749;
        }

        .btn-red {
            background-color: #e53e3e;
            color: white;
        }

        .btn-red:hover {
            background-color: #c53030;
        }

        .btn-gray {
            background-color: #cbd5e0;
            color: #4a5568;
        }

        .btn-gray:hover {
            background-color: #a0aec0;
        }

        .btn-navy {
            background-color: #2c3e50;
            color: white;
        }

        .btn-navy:hover {
            background-color: #1a252f;
        }

        .btn-cyan {
            background-color: #008080;
            /* Teal/Cyan base */
            color: white;
        }

        .btn-cyan:hover {
            background-color: #006666;
        }

        .btn-success {
            background-color: #108043;
            /* Shopify Green */
            color: white;
        }

        .btn-success:hover {
            background-color: #0b6032;
        }


        .scm-table-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }

        .scm-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .scm-table th,
        .scm-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        .scm-table th {
            background-color: #f7fafc;
            font-weight: 600;
            color: #4a5568;
            white-space: nowrap;
        }

        .scm-table tr:hover {
            background-color: #f8fafc;
        }

        .status-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-active {
            background-color: #c6f6d5;
            color: #22543d;
        }

        .status-inactive {
            background-color: #fed7d7;
            color: #822727;
        }

        .status-normal {
            background-color: #ebf8ff;
            color: #2c5282;
            border: 1px solid #bee3f8;
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7rem;
            margin-bottom: 2px;
        }

        .status-selling {
            background-color: #c6f6d5;
            color: #22543d;
            border: 1px solid #9ae6b4;
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7rem;
            margin-bottom: 2px;
        }

        .product-img-thumb {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 4px;
            border: 1px solid #eee;
            cursor: pointer;
        }

        .pagination {
            display: flex;
            justify-content: center;
            padding: 1.5rem;
            gap: 0.5rem;
        }

        .page-btn {
            padding: 0.5rem 0.75rem;
            border: 1px solid #e2e8f0;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            color: #4a5568;
        }

        .page-btn.active {
            background-color: #3182ce;
            color: white;
            border-color: #3182ce;
        }

        .page-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Modal Styles */
        .scm-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .scm-modal {
            background: white;
            border-radius: 8px;
            width: 100%;
            max-width: 800px;
            /* Default, overridden inline */
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            display: none;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3182ce;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body class="scm-body">

    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
    </div>

    <!-- Sidebar (User Mode Style) -->
    <aside class="scm-sidebar" id="scmSidebar">
        <div class="scm-logo-area">
            <a href="index.html">RIUM<br>SCM</a>
        </div>
        <nav class="scm-menu">
            <a href="scm_dashboard.html" class="scm-menu-item">
                <i class="fas fa-home"></i>
                <span>대시보드</span>
            </a>

            <a href="#" class="scm-menu-item user-mode-btn">
                <i class="fas fa-user"></i>
                <span>사용자 모드</span>
            </a>

            <a href="scm_products.html" class="scm-menu-item active">
                <i class="fas fa-box"></i>
                <span>상품 관리</span>
            </a>

            <a href="scm_orders.html" class="scm-menu-item">
                <i class="fas fa-file-invoice-dollar"></i>
                <span>견적/발주<br>관리</span>
            </a>

            <a href="#" class="scm-menu-item">
                <i class="fas fa-exchange-alt"></i>
                <span>반품/교환</span>
            </a>
            <a href="#" class="scm-menu-item">
                <i class="fas fa-calculator"></i>
                <span>정산 관리</span>
            </a>
            <a href="#" class="scm-menu-item">
                <i class="fas fa-bullhorn"></i>
                <span>공지사항</span>
            </a>
            <a href="#" class="scm-menu-item">
                <i class="fas fa-cog"></i>
                <span>설정</span>
            </a>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="scm-main">
        <div class="scm-header">
            <div style="color: #718096;">
                <i class="fas fa-home"></i> Home > 상품 관리
            </div>
            <div style="display: flex; gap: 1rem; align-items: center;">
                <span id="adminNameDisplay" style="font-weight: 600;">관리자님</span>
                <button id="logoutBtn" class="scm-btn btn-gray btn-sm">로그아웃</button>
            </div>
        </div>

        <!-- Action Bar -->
        <div class="scm-action-bar">
            <!-- (Content remains same as previous, just adjusting container context if needed) -->
            <div class="scm-action-group">
                <span style="font-weight:600; margin-right:10px;">서버 원본 교체:</span>
                <label for="excelFile" class="scm-btn btn-gray btn-sm" style="cursor: pointer;">파일 선택</label>
                <input type="file" id="excelFile" accept=".xlsx, .xls" style="display: none;">
                <span id="fileName" style="font-size: 0.8rem; color: #666;">선택된 파일 없음</span>
                <button class="scm-btn btn-blue btn-sm" onclick="handleExcelUpload()">파일 교체</button>
            </div>

            <div class="scm-action-group" style="padding-left: 20px; margin-left: 20px; border-left: 1px solid #eee;">
                <span style="font-weight:600; margin-right:10px;">서버 엑셀 등록:</span>
                <input type="number" id="startRow" class="scm-input" placeholder="시작" style="width: 60px;">
                <span style="margin: 0 5px;">~</span>
                <input type="number" id="endRow" class="scm-input" placeholder="종료" style="width: 60px;">
                <button class="scm-btn btn-blue btn-sm" onclick="handleExcelToDb()">범위 등록</button>
            </div>

            <!-- Right Aligned Group -->
            <div style="margin-left: auto; display: flex; gap: 10px; align-items: center;">
                <button class="scm-btn btn-blue" onclick="downloadExcel()">전체 다운로드</button>
                <button class="scm-btn btn-blue" onclick="downloadTemplate()">양식</button>
                <button class="scm-btn btn-blue" onclick="deleteRange()">구간 삭제</button>
                <button class="scm-btn btn-cyan">카테고리 관리</button>
                <button class="scm-btn btn-navy" onclick="openProductModal()"><i class="fas fa-plus"></i> 신규 등록</button>
            </div>
        </div>

        <!-- Filter Options Row -->
        <div style="margin-bottom: 1rem; text-align: right;">
            <select class="scm-select" id="filterCategory">
                <option value="">전체 카테고리</option>
            </select>
        </div>


        <!-- Product Table -->
        <div class="scm-table-container">
            <table class="scm-table">
                <thead>
                    <tr>
                        <th style="width: 50px;">No.</th>
                        <th style="width: 60px;">IMG</th>
                        <th>브랜드</th>
                        <th>상품명/모델명/옵션</th>
                        <th style="min-width: 80px; text-align: right;">실판매가</th>
                        <th style="min-width: 80px; text-align: right;">공급가</th>
                        <th style="width: 80px; text-align: center;">재고</th>
                        <th style="width: 80px; text-align: center;">배송비</th>
                        <th>제조사/원산지/등록일</th>
                        <th style="width: 100px; text-align: center;">상태/관리</th>
                    </tr>
                </thead>
                <tbody id="productListBody">
                    <!-- Populated by JS -->
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        <div class="pagination" id="pagination">
            <!-- Populated by JS -->
        </div>
    </main>

    <!-- --------------------------------------------------- -->
    <!-- MODALS -->
    <!-- --------------------------------------------------- -->

    <!-- Category Modal -->
    <div id="categoryModal" class="scm-modal-overlay"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
        <div class="scm-modal"
            style="background: white; padding: 2rem; border-radius: 8px; width: 600px; max-height: 80vh; overflow-y: auto;">
            <h3 style="margin-top: 0; margin-bottom: 2rem;">카테고리 관리</h3>

            <div class="scm-input-group" style="margin-bottom: 2rem; align-items: flex-end;">
                <div style="flex: 1;">
                    <label>카테고리명</label>
                    <input type="text" id="newCatName" class="scm-input" style="width: 100%;" placeholder="예: Living">
                </div>
                <div style="width: 150px; margin-left:10px;">
                    <label>슬러그 (영문)</label>
                    <input type="text" id="newCatSlug" class="scm-input" style="width: 100%;" placeholder="자동 생성됨"
                        readonly>
                </div>
                <div style="width: 60px; margin-left:10px;">
                    <label>색상</label>
                    <input type="color" id="newCatColor" class="scm-input"
                        style="width: 100%; height: 38px; padding: 2px;" value="#ffffff">
                </div>
                <button class="scm-btn btn-navy" id="btnAddCategory"
                    style="height: 38px; margin-left: 10px;">추가</button>
                <button class="scm-btn btn-success" id="btnUpdateCategory"
                    style="height: 38px; margin-left: 10px; display: none;">수정</button>
                <button class="scm-btn btn-red" id="btnCancelEdit"
                    style="height: 38px; margin-left: 10px; display: none;">취소</button>
            </div>

            <div class="scm-table-container">
                <table class="scm-table">
                    <thead>
                        <tr>
                            <th style="width: 50px;">ID</th>
                            <th>이름</th>
                            <th>슬러그</th>
                            <th>색상</th>
                            <th style="width: 120px;">관리</th>
                        </tr>
                    </thead>
                    <tbody id="categoryListBody">
                        <!-- JS Populated -->
                    </tbody>
                </table>
            </div>

            <div style="text-align: right; margin-top: 2rem;">
                <button class="scm-btn btn-gray" id="btnCloseCatModal">닫기</button>
            </div>
        </div>
    </div>


    <!-- Product Editor Modal -->
    <div id="productModal" class="scm-modal-overlay"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
        <div class="scm-modal"
            style="background: white; padding: 1.5rem; border-radius: 8px; width: 1400px; max-width: 98%; max-height: 95vh; overflow-y: auto;">
            <h3 id="productModalTitle"
                style="margin-top: 0; margin-bottom: 1rem; border-bottom: 1px solid #eee; padding-bottom: 0.5rem;">신규 등록
            </h3>
            <form id="productForm">
                <input type="hidden" id="p_id">
                <!-- Row 1: Basic Info -->
                <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap: 10px;">
                    <div>
                        <label>상품명 (필수)</label>
                        <input type="text" id="p_name" class="scm-input" style="width: 100%;" required>
                    </div>
                    <div>
                        <label>모델번호</label>
                        <input type="text" id="p_modelNo" class="scm-input" style="width: 100%;">
                    </div>
                    <div>
                        <label>브랜드</label>
                        <input type="text" id="p_brand" class="scm-input" style="width: 100%;">
                    </div>
                    <div>
                        <label>카테고리 (필수)</label>
                        <select id="p_categoryId" class="scm-select" style="width: 100%;" required>
                            <!-- Populated -->
                        </select>
                    </div>
                </div>

                <!-- Row 2: Prices & Quantities -->
                <div
                    style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr 1fr 1fr; gap: 10px; margin-top: 10px;">
                    <div>
                        <label>소비자가</label>
                        <input type="text" id="p_consumerPrice" class="scm-input" style="width: 100%;"
                            oninput="formatNumberInput(this)">
                    </div>
                    <div>
                        <label>공급가</label>
                        <input type="text" id="p_supplyPrice" class="scm-input" style="width: 100%;"
                            oninput="formatNumberInput(this)">
                    </div>
                    <div>
                        <label>B2B 가격</label>
                        <input type="text" id="p_b2bPrice" class="scm-input" style="width: 100%;"
                            oninput="formatNumberInput(this)">
                    </div>
                    <div>
                        <label>재고수량</label>
                        <input type="number" id="p_stockQuantity" class="scm-input" style="width: 100%;">
                    </div>
                    <div>
                        <label>박스당 수량</label>
                        <input type="number" id="p_quantityPerCarton" class="scm-input" style="width: 100%;">
                    </div>
                    <div>
                        <label>순서</label>
                        <input type="number" id="p_displayOrder" class="scm-input" style="width: 100%;" placeholder="0">
                    </div>
                </div>

                <!-- Row 3: Shipping & Origin -->
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px; margin-top: 10px;">
                    <div>
                        <label>배송비 (개별)</label>
                        <input type="text" id="p_shippingFeeIndividual" class="scm-input" style="width: 100%;"
                            oninput="formatNumberInput(this)">
                    </div>
                    <div>
                        <label>배송비 (박스)</label>
                        <input type="text" id="p_shippingFeeCarton" class="scm-input" style="width: 100%;"
                            oninput="formatNumberInput(this)">
                    </div>
                    <div>
                        <label>제조사</label>
                        <input type="text" id="p_manufacturer" class="scm-input" style="width: 100%;">
                    </div>
                    <div>
                        <label>원산지</label>
                        <input type="text" id="p_origin" class="scm-input" style="width: 100%;">
                    </div>
                </div>

                <!-- Row 4: URLs -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                    <div>
                        <label>대표 이미지 URL</label>
                        <input type="text" id="p_imageUrl" class="scm-input" style="width: 100%;">
                    </div>
                    <div>
                        <label>상세 페이지 URL</label>
                        <input type="text" id="p_detailUrl" class="scm-input" style="width: 100%;">
                    </div>
                </div>

                <!-- Row 5: Spec & Options -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                    <div>
                        <label>제품 스펙 (한 줄 입력)</label>
                        <input type="text" id="p_productSpec" class="scm-input" style="width: 100%;"
                            placeholder="예: 200g x 30ea">
                    </div>
                    <div>
                        <label>옵션 (콤마로 구분)</label>
                        <input type="text" id="p_productOptions" class="scm-input" style="width: 100%;"
                            placeholder="예: Red, Blue, Green">
                    </div>
                </div>


                <!-- Row 6: Remarks & Flags -->
                <div style="margin-top: 10px;">
                    <label>비고</label>
                    <textarea id="p_remarks" class="scm-input" style="width: 100%; height: 60px;"></textarea>
                </div>

                <!-- Moved Checkboxes to Bottom -->


                <!-- Description Editor (Simple Textarea for now) -->
                <div style="margin-top: 15px;">
                    <label>상세 설명 (HTML)</label>
                    <textarea id="p_description" class="scm-input" style="width: 100%; height: 200px;"></textarea>
                </div>

                <!-- Row 6: Flags (Moved here) -->
                <div style="margin-top: 10px; display: flex; gap: 20px;">
                    <label style="display: flex; align-items: center; gap: 5px;">
                        <input type="checkbox" id="p_isAvailable" checked> 판매 가능
                    </label>
                    <label style="display: flex; align-items: center; gap: 5px;">
                        <input type="checkbox" id="p_isNew"> 신상품 (NEW)
                    </label>
                    <label style="display: flex; align-items: center; gap: 5px;">
                        <input type="checkbox" id="p_isTaxFree"> 면세 상품
                    </label>
                </div>

                <div style="margin-top: 2rem; text-align: right; padding-top: 1rem; border-top: 1px solid #eee;">
                    <button type="button" class="scm-btn btn-gray" id="btnCloseProdModal">취소</button>
                    <button type="submit" class="scm-btn btn-blue" id="btnSaveProduct">저장</button>
                </div>
            </form>
        </div>
    </div>


    <script>
        const API_BASE = 'https://rium-scm-backend.onrender.com'; // Change to local if needed
        let currentProducts = [];
        let totalItems = 0;
        let currentPage = 1;
        const itemsPerPage = 20;

        // AUTH & INIT
        document.addEventListener('DOMContentLoaded', () => {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = 'scm_login.html';
                return;
            }
            // Parse JWT for username if possible, or just default
            document.getElementById('adminNameDisplay').innerText = localStorage.getItem('username') || '관리자';

            loadCategories();
            loadProducts();

            // Add Global Event Listeners for category filtering
            const filterCategory = document.getElementById('filterCategory');
            if (filterCategory) {
                filterCategory.onchange = () => {
                    loadProducts(1); // Reset to page 1 when filtering
                };
            }
        });

        document.getElementById('logoutBtn').addEventListener('click', () => {
            localStorage.removeItem('token');
            localStorage.removeItem('username');
            window.location.href = 'scm_login.html';
        });

        // Toggle User Mode (New Tab)
        document.querySelector('.user-mode-btn').addEventListener('click', (e) => {
            e.preventDefault();
            window.open('index.html', '_blank');
        });


        // HELPER: Fetch with Auth
        const apiFetch = async (url, options = {}) => {
            options.credentials = 'include'; // Send Cookies

            // Add Token if available (Fix for Session Expiry issue)
            const token = localStorage.getItem('token');
            if (token) {
                options.headers = {
                    ...options.headers,
                    'Authorization': `Bearer ${token}`
                };
            }

            const res = await fetch(`${API_BASE}${url}`, options);
            if (res.status === 401) {
                alert('세션이 만료되었습니다. 다시 로그인해주세요.');
                window.location.href = 'scm_login.html';
                return;
            }
            if (!res.ok) {
                const err = await res.json().catch(() => ({}));
                throw new Error(err.error || err.message || 'Request failed');
            }
            return res.json();
        };


        // --- PRODUCT MANAGEMENT ---

        const productModal = document.getElementById('productModal');
        const productForm = document.getElementById('productForm');

        // Load Products
        // Load Products
        async function loadProducts(page = 1) {
            showLoading(true);
            try {
                let url = `/api/products?page=${page}&limit=${itemsPerPage}&sort=id_desc`;
                // Add Filter
                const filterCategory = document.getElementById('filterCategory');
                if (filterCategory && filterCategory.value) {
                    url += `&categoryId=${filterCategory.value}`;
                }

                const data = await apiFetch(url);
                currentProducts = data.products;
                totalItems = data.pagination.totalItems;
                currentPage = Number(data.pagination.currentPage);

                renderTable();
                renderPagination();
            } catch (e) {
                alert('상품 로딩 실패: ' + e.message);
            } finally {
                showLoading(false);
            }
        };

        const renderTable = () => {
            const tbody = document.getElementById('productListBody');
            tbody.innerHTML = currentProducts.map(p => `
                <tr>
                    <td>${p.id}</td>
                    <td>
                        <img src="${p.image_url || 'https://via.placeholder.com/50'}" class="product-img-thumb" 
                             onclick="window.open('${p.image_url || '#'}', '_blank')" 
                             onerror="this.src='https://via.placeholder.com/50?text=No+Img'">
                    </td>
                    <td style="font-weight:600; color:#4a5568;">${p.brand || '-'}
                        <div style="font-size:0.75rem; color:#3182ce;">${p.category_name || ''}</div>
                    </td>
                    <td>
                        <div style="font-weight:bold; color:#2d3748; margin-bottom:2px;">
                            ${p.is_new ? '<span style="color:red; font-size:0.7rem; font-weight:bold;">[NEW]</span> ' : ''}
                            <a href="#" class="edit-btn" data-id="${p.id}" style="color:#2d3748; text-decoration:none;">
                                ${p.model_name}
                            </a>
                        </div>
                        <div style="font-size:0.8rem; color:#718096;">${p.product_options || '-'}</div>
                        <div style="font-size:0.75rem; color:#a0aec0;">${p.model_no || 'No Model #'}</div>
                    </td>
                    
                    <td style="text-align: right;">
                        <div style="color:#3182ce; font-weight:bold;">${formatPrice(p.consumer_price)}</div>
                        <div style="font-size:0.75rem;"><span style="color:#e53e3e;">${p.is_tax_free ? '면세' : '과세'}</span></div>
                    </td>
                     <td style="text-align: right;">
                        <div style="color:#4a5568;">소가 ${formatPrice(p.supply_price)}</div>
                        <div style="font-weight:bold;">공급 ${formatPrice(p.b2b_price)}</div>
                    </td>

                    <td style="text-align: center;">
                        <div style="font-weight:bold;">재고 ${p.stock_quantity}</div>
                        <div style="font-size:0.75rem; color:#718096;">카톤 ${p.quantity_per_carton || 0}</div>
                    </td>
                     <td style="text-align: center;">
                        <div style="font-size:0.8rem;">개별 ${formatPrice(p.shipping_fee_individual)}</div>
                        <div style="font-size:0.8rem;">카톤 ${formatPrice(p.shipping_fee_carton)}</div>
                    </td>

                    <td style="font-size:0.85rem;">
                        <div>제조: ${p.manufacturer || '-'}</div>
                        <div>원산: ${p.origin || '-'}</div>
                        <div style="color:#a0aec0;">${new Date(p.created_at).toLocaleDateString()}</div>
                    </td>
                    
                    <td style="text-align: center;">
                       <span class="status-badge ${p.is_available ? 'status-active' : 'status-inactive'}" 
                             style="cursor:pointer;" onclick="toggleProductStatus(${p.id})">
                          ${p.is_available ? 'Normal' : 'SoldOut'}
                       </span><br>
                       <span class="status-selling" style="cursor:pointer;" onclick="toggleProductStatus(${p.id})">
                            ${p.is_available ? 'Selling' : 'Stop'}
                       </span>
                       <div style="margin-top:5px; display: flex; gap: 2px; justify-content: center;">
                            <button class="scm-btn btn-navy btn-sm" onclick="openProductModal(${p.id})">수정</button>
                            <button class="scm-btn btn-navy btn-sm" onclick="deleteProduct(${p.id})">삭제</button>
                       </div>
                    </td>
                </tr>
            `).join('');
        };

        const renderPagination = () => {
            const container = document.getElementById('pagination');
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            let html = '';

            // Prev
            html += `<button class="page-btn" ${currentPage === 1 ? 'disabled' : ''} onclick="loadProducts(${currentPage - 1})"><</button>`;

            // Range (Showing 5 pages around current)
            let start = Math.max(1, currentPage - 2);
            let end = Math.min(totalPages, start + 4);
            if (end - start < 4) start = Math.max(1, end - 4);

            for (let i = start; i <= end; i++) {
                html += `<button class="page-btn ${i === currentPage ? 'active' : ''}" onclick="loadProducts(${i})">${i}</button>`;
            }

            // Next
            html += `<button class="page-btn" ${currentPage === totalPages ? 'disabled' : ''} onclick="loadProducts(${currentPage + 1})">></button>`;

            container.innerHTML = html;
        };


        // --- MODAL & FORM LOGIC ---

        // Open Modal (New / Edit)
        window.openProductModal = async (id = null) => {
            productModal.style.display = 'flex';
            productForm.reset();
            document.getElementById('p_id').value = '';
            document.getElementById('productModalTitle').innerText = id ? '상품 수정' : '신규 등록';

            if (id) {
                const p = currentProducts.find(x => x.id == id);
                if (p) {
                    document.getElementById('p_id').value = p.id;
                    document.getElementById('p_name').value = p.model_name; // Mapping model_name to Name UI
                    document.getElementById('p_modelNo').value = p.model_no;
                    document.getElementById('p_brand').value = p.brand;
                    document.getElementById('p_categoryId').value = p.category_id;

                    document.getElementById('p_consumerPrice').value = parseInt(p.consumer_price || 0).toLocaleString();
                    document.getElementById('p_supplyPrice').value = parseInt(p.supply_price || 0).toLocaleString();
                    document.getElementById('p_b2bPrice').value = parseInt(p.b2b_price || 0).toLocaleString();
                    document.getElementById('p_stockQuantity').value = p.stock_quantity;
                    document.getElementById('p_quantityPerCarton').value = p.quantity_per_carton;

                    document.getElementById('p_shippingFeeIndividual').value = parseInt(p.shipping_fee_individual || 0).toLocaleString();
                    document.getElementById('p_shippingFeeCarton').value = parseInt(p.shipping_fee_carton || 0).toLocaleString();
                    document.getElementById('p_manufacturer').value = p.manufacturer;
                    document.getElementById('p_origin').value = p.origin;

                    document.getElementById('p_imageUrl').value = p.image_url;
                    document.getElementById('p_detailUrl').value = p.detail_url;
                    document.getElementById('p_description').value = p.description;
                    document.getElementById('p_productOptions').value = p.product_options;
                    document.getElementById('p_productSpec').value = p.product_spec;
                    document.getElementById('p_displayOrder').value = p.display_order;
                    document.getElementById('p_remarks').value = p.remarks;

                    document.getElementById('p_isAvailable').checked = p.is_available;
                    document.getElementById('p_isNew').checked = p.is_new;
                    document.getElementById('p_isTaxFree').checked = p.is_tax_free;
                }
            }
        };

        // Close Modal
        document.getElementById('btnCloseProdModal').onclick = () => {
            productModal.style.display = 'none';
        };

        // Save
        productForm.onsubmit = async (e) => {
            e.preventDefault();
            const id = document.getElementById('p_id').value;
            const payload = {
                modelName: document.getElementById('p_name').value,
                modelNo: document.getElementById('p_modelNo').value,
                brand: document.getElementById('p_brand').value,
                categoryId: document.getElementById('p_categoryId').value,

                consumerPrice: getRawNumber('p_consumerPrice'),
                supplyPrice: getRawNumber('p_supplyPrice'),
                b2bPrice: getRawNumber('p_b2bPrice'),
                stockQuantity: document.getElementById('p_stockQuantity').value,
                quantityPerCarton: document.getElementById('p_quantityPerCarton').value,

                shippingFeeIndividual: getRawNumber('p_shippingFeeIndividual'),
                shippingFeeCarton: getRawNumber('p_shippingFeeCarton'),
                manufacturer: document.getElementById('p_manufacturer').value,
                origin: document.getElementById('p_origin').value,

                imageUrl: document.getElementById('p_imageUrl').value,
                detailUrl: document.getElementById('p_detailUrl').value,
                description: document.getElementById('p_description').value,
                productOptions: document.getElementById('p_productOptions').value,
                productSpec: document.getElementById('p_productSpec').value,
                displayOrder: document.getElementById('p_displayOrder').value,
                remarks: document.getElementById('p_remarks').value,

                isAvailable: document.getElementById('p_isAvailable').checked,
                isNew: document.getElementById('p_isNew').checked,
                isTaxFree: document.getElementById('p_isTaxFree').checked
            };

            showLoading(true);
            try {
                if (id) {
                    await apiFetch(`/api/products/${id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                } else {
                    await apiFetch('/api/products', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                }
                productModal.style.display = 'none';
                loadProducts(currentPage);
            } catch (e) {
                alert('저장 실패: ' + e.message);
            } finally {
                showLoading(false);
            }
        };


        // Format Number Input (Comma)
        const formatNumberInput = (input) => {
            let val = input.value.replace(/[^0-9]/g, ""); // Remove non-numeric
            if (val) {
                input.value = parseInt(val).toLocaleString();
            } else {
                input.value = "";
            }
        };

        // Helper to get raw number from formatted input
        const getRawNumber = (id) => {
            const val = document.getElementById(id).value.replace(/,/g, '');
            return val ? parseInt(val) : 0;
        };

        // Toggle Status
        const toggleProductStatus = async (id) => {
            const p = currentProducts.find(x => x.id === id);
            if (!p) return;

            const newStatus = !p.is_available;
            if (!confirm(`상품 상태를 ${newStatus ? '판매중(Normal)' : '품절(SoldOut)'}으로 변경하시겠습니까?`)) return;

            try {
                // We only need to update isAvailable. The PUT endpoint expects full object usually, 
                // but we can try sending just the flag if backend supports partial updates, 
                // OR we have to send everything. 
                // Looking at backend code: it destructures ALL fields. So we must send full payload.
                // However, fetching full details just to toggle boolean is inefficient. 
                // For now, let's use the object from `currentProducts` but we need to match the payload structure of `onsubmit`.

                // Construct payload from `p` (currentProducts item)
                const payload = {
                    categoryId: p.category_id,
                    brand: p.brand,
                    modelName: p.model_name,
                    description: p.description,
                    imageUrl: p.image_url,
                    b2bPrice: p.b2b_price,
                    stockQuantity: p.stock_quantity,
                    isAvailable: newStatus,
                    detailUrl: p.detail_url,
                    consumerPrice: p.consumer_price,
                    supplyPrice: p.supply_price,
                    quantityPerCarton: p.quantity_per_carton,
                    manufacturer: p.manufacturer,
                    origin: p.origin,
                    isTaxFree: p.is_tax_free,
                    shippingFeeIndividual: p.shipping_fee_individual,
                    shippingFeeCarton: p.shipping_fee_carton,
                    productOptions: p.product_options,
                    modelNo: p.model_no,
                    remarks: p.remarks,
                    displayOrder: p.display_order,
                    productSpec: p.product_spec,
                    isNew: p.is_new
                };

                await apiFetch(`/api/products/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                // Optimistic UI update or reload
                loadProducts(currentPage);

            } catch (e) {
                alert('상태 변경 실패: ' + e.message);
            }
        };

        // Delete Product
        window.deleteProduct = async (id) => {
            if (!confirm('정말 삭제하시겠습니까?')) return;
            try {
                await apiFetch(`/api/products/${id}`, { method: 'DELETE' });
                loadProducts(currentPage);
            } catch (e) { alert(e.message); }
        };



        // --- EXCEL & BULK ACTIONS ---

        const handleExcelUpload = () => {
            document.getElementById('excelFile').click();
        };

        // File Input Change
        document.getElementById('excelFile').onchange = async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            if (!confirm(`${file.name} 파일로 서버 데이터를 덮어쓰시겠습니까? (매우 위험)`)) {
                e.target.value = null;
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            showLoading(true);
            try {
                const res = await apiFetch('/api/upload/excel-full', {
                    method: 'POST',
                    body: formData // No Content-Type header (browser sets it)
                });
                alert(`${res.message} (${res.count}개 상품)`);
                loadProducts();
            } catch (e) {
                alert('업로드 실패: ' + e.message);
            } finally {
                showLoading(false);
                e.target.value = null;
            }
        };


        // Range Register
        const handleExcelToDb = async () => {
            const start = document.getElementById('startRow').value;
            const end = document.getElementById('endRow').value;

            if (!start || !end) return alert('시작/종료 번호를 입력하세요');

            if (!confirm(`${start} ~ ${end} 구간의 상품을 엑셀에서 DB로 등록하시겠습니까?`)) return;

            showLoading(true);
            try {
                const res = await apiFetch('/api/upload/register-range', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ start, end })
                });
                alert(`${res.message} (${res.count}개 등록)`);
                loadProducts();
            } catch (e) { alert(e.message); }
            finally { showLoading(false); }
        };


        // Download All
        const downloadExcel = () => {
            // Direct link or API blob
            window.location.href = `${API_BASE}/api/excel/download`;
        };

        // Download Template
        const downloadTemplate = () => {
            // Assuming static file or generated
            alert('준비중입니다.');
        };

        // Delete Range
        const deleteRange = async () => {
            const start = prompt('삭제할 시작 ID를 입력하세요:');
            if (!start) return;
            const end = prompt('삭제할 종료 ID를 입력하세요:');
            if (!end) return;

            if (!confirm(`ID ${start} ~ ${end} 구간의 상품을 정말 삭제하시겠습니까?`)) return;

            try {
                const res = await apiFetch(`/api/products/range?startId=${start}&endId=${end}`, {
                    method: 'DELETE'
                });
                alert(`${res.count}개 삭제 완료`);
                loadProducts();
            } catch (e) { alert('실패: ' + e.message); }
        };

        // --- CATEGORY MANAGEMENT ---
        const categoryModal = document.getElementById('categoryModal');
        const catListBody = document.getElementById('categoryListBody');
        const categorySelect = document.getElementById('p_categoryId');
        const filterCategory = document.getElementById('filterCategory');

        // Input Elements
        const newCatName = document.getElementById('newCatName');
        const newCatColor = document.getElementById('newCatColor');
        const btnAddCategory = document.getElementById('btnAddCategory');
        const btnUpdateCategory = document.getElementById('btnUpdateCategory');
        const btnCancelEdit = document.getElementById('btnCancelEdit');

        // State
        let editingCategoryId = null;

        async function loadCategories() {
            try {
                const data = await apiFetch('/api/categories');
                // Backend returns array directly, handle both cases for safety
                const cats = Array.isArray(data) ? data : (data.categories || []);

                catListBody.innerHTML = cats.map(c => `
                        <tr>
                            <td>${c.id}</td>
                            <td>${c.name}</td>
                            <td>${c.slug}</td>
                            <td>
                                <div style="display:flex; align-items:center; gap:5px;">
                                    <div style="width:20px; height:20px; background-color:${c.color || '#ffffff'}; border:1px solid #ddd; border-radius:4px;"></div>
                                    <span style="font-size:0.8rem; color:#888;">${c.color || '#ffffff'}</span>
                                </div>
                            </td>
                            <td>
                                <button class="scm-btn btn-success btn-sm btn-edit-cat" data-id="${c.id}" data-name="${c.name}" data-color="${c.color}">수정</button>
                                <button class="scm-btn btn-red btn-sm btn-del-cat" data-id="${c.id}">삭제</button>
                            </td>
                        </tr>
                    `).join('');

                categorySelect.innerHTML = '<option value="">선택하세요</option>' +
                    cats.map(c => `<option value="${c.id}">${c.name}</option>`).join('');

                // Populate Filter (Keep "All" option)
                if (filterCategory) {
                    const currentVal = filterCategory.value;
                    filterCategory.innerHTML = '<option value="">전체 카테고리</option>' +
                        cats.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
                    filterCategory.value = currentVal; // Restore selection
                }

            } catch (e) { console.error(e); }
        };

        // Add/Update Logic
        const saveCategory = async () => {
            const name = newCatName.value.trim();
            const color = newCatColor ? newCatColor.value : '#ffffff';
            if (!name) return alert('카테고리명을 입력하세요');

            if (editingCategoryId) {
                // Update
                try {
                    await apiFetch(`/api/categories/${editingCategoryId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name, color })
                    });
                    resetEditMode();
                    loadCategories();
                } catch (e) { alert(e.message); }
            } else {
                // Create
                try {
                    const res = await apiFetch('/api/categories', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name, color })
                    });
                    newCatName.value = '';
                    if (newCatColor) newCatColor.value = '#ffffff';
                    loadCategories();
                } catch (e) { alert(e.message); }
            }
        };

        // Use event delegation or check existence
        document.addEventListener('click', (e) => {
            if (e.target.id === 'btnAddCategory' || e.target.id === 'btnUpdateCategory') {
                saveCategory();
            }
            if (e.target.id === 'btnCancelEdit') {
                resetEditMode();
            }
        });

        // Edit Mode Trigger
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('btn-edit-cat')) {
                const btn = e.target;
                editingCategoryId = btn.dataset.id;
                if (newCatName) newCatName.value = btn.dataset.name;
                if (newCatColor) newCatColor.value = btn.dataset.color || '#ffffff';

                if (btnAddCategory) btnAddCategory.style.display = 'none';
                if (btnUpdateCategory) btnUpdateCategory.style.display = 'inline-block';
                if (btnCancelEdit) btnCancelEdit.style.display = 'inline-block';
            }

            if (e.target.classList.contains('btn-del-cat')) {
                if (!confirm('정말 삭제하시겠습니까? 상품이 있는 카테고리는 삭제할 수 없습니다.')) return;
                deleteCategory(e.target.dataset.id);
            }
        });

        function resetEditMode() {
            editingCategoryId = null;
            if (newCatName) newCatName.value = '';
            if (newCatColor) newCatColor.value = '#ffffff';

            if (btnAddCategory) btnAddCategory.style.display = 'inline-block';
            if (btnUpdateCategory) btnUpdateCategory.style.display = 'none';
            if (btnCancelEdit) btnCancelEdit.style.display = 'none';
        }

        const deleteCategory = async (id) => {
            try {
                await apiFetch(`/api/categories/${id}`, { method: 'DELETE' });
                loadCategories();
            } catch (e) { alert(e.message); }
        };


        // Open Modal
        document.querySelectorAll('button').forEach(btn => {
            if (btn.innerText.includes('카테고리 관리')) {
                btn.onclick = (e) => { e.preventDefault(); categoryModal.style.display = 'flex'; loadCategories(); };
            }
        });
        document.getElementById('btnCloseCatModal').onclick = () => {
            categoryModal.style.display = 'none';
            resetEditMode();
        };

        // Utility
        const formatPrice = (price) => {
            return price ? parseInt(price).toLocaleString() + '원' : '0원';
        };

        const showLoading = (show) => {
            document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
        };

        // New Button
        document.querySelector('button.btn-navy i.fa-plus').parentElement.onclick = () => openProductModal();

    </script>
</body>

</html>